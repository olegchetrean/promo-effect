// Promo-Efect Logistics Platform - SQLite Compatible Schema
// Generated: December 2025

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. AUTHENTICATION & USERS
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  phone         String?
  company       String?
  role          String    @default("CLIENT") // CLIENT, AGENT, ADMIN, SUPER_ADMIN

  emailVerified Boolean   @default(false) @map("email_verified")
  verificationToken String? @unique @map("verification_token")

  resetToken     String?  @unique @map("reset_token")
  resetTokenExpiry DateTime? @map("reset_token_expiry")

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  // Relations
  sessions      Session[]
  notifications Notification[]
  auditLogs     AuditLog[]
  createdAgents Agent[]   @relation("CreatedBy")
  agentProfile  Agent?    @relation("AgentUser")

  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  token        String   @unique
  refreshToken String   @unique @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")

  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// ============================================
// 2. CLIENTS & AGENTS
// ============================================

model Client {
  id            String   @id @default(uuid())
  companyName   String   @map("company_name")
  contactPerson String   @map("contact_person")
  email         String   @unique
  phone         String
  address       String?

  // Business info
  taxId         String?  @unique @map("tax_id")
  bankAccount   String?  @map("bank_account")

  // Stats
  totalBookings Int      @default(0) @map("total_bookings")
  totalRevenue  Float    @default(0) @map("total_revenue")

  status        String   @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  lastBookingAt DateTime? @map("last_booking_at")

  // Relations
  bookings Booking[]
  invoices Invoice[]

  @@index([email])
  @@index([status])
  @@map("clients")
}

model Agent {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  agentCode   String   @unique @map("agent_code")
  company     String

  // Contact in China
  contactName String   @map("contact_name")
  wechatId    String?  @map("wechat_id")

  status      String   @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED

  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user        User         @relation("AgentUser", fields: [userId], references: [id], onDelete: Cascade)
  createdBy   User         @relation("CreatedBy", fields: [createdById], references: [id])
  prices      AgentPrice[]
  bookings    Booking[]

  @@index([agentCode])
  @@index([status])
  @@map("agents")
}

// ============================================
// 3. PRICING SYSTEM
// ============================================

model AgentPrice {
  id            String   @id @default(uuid())
  agentId       String?  @map("agent_id")
  addedByAdmin  String?  @map("added_by_admin")

  // Price details
  freightPrice  Float    @map("freight_price")
  shippingLine  String   @map("shipping_line")

  // Route & specs
  portOrigin    String   @map("port_origin")
  containerType String   @map("container_type")
  weightRange   String   @map("weight_range")

  // Validity
  validFrom     DateTime @map("valid_from")
  validUntil    DateTime @map("valid_until")
  departureDate DateTime @map("departure_date")

  // Admin override info
  reason        String?

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  agent   Agent?   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([portOrigin, containerType, weightRange])
  @@index([agentId])
  @@map("agent_prices")
}

model AdminSettings {
  id                    Int      @id @default(1)

  // Fixed costs (USD)
  portTaxes             Float    @default(221.67) @map("port_taxes")
  customsTaxes          Float    @default(150.00) @map("customs_taxes")
  terrestrialTransport  Float    @default(600.00) @map("terrestrial_transport")
  commission            Float    @default(200.00) @map("commission")

  // Weight ranges config (stored as JSON string)
  weightRanges          String   @default("[{\"label\": \"1-10 tone\", \"min\": 1, \"max\": 10, \"enabled\": true}, {\"label\": \"10-20 tone\", \"min\": 10, \"max\": 20, \"enabled\": true}, {\"label\": \"20-23 tone\", \"min\": 20, \"max\": 23, \"enabled\": true}, {\"label\": \"23-24 tone\", \"min\": 23, \"max\": 24, \"enabled\": true}]") @map("weight_ranges")

  updatedBy String?  @map("updated_by")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("admin_settings")
}

// ============================================
// 4. BOOKINGS & CONTAINERS
// ============================================

model Booking {
  id         String   @id

  // Relationships
  clientId   String   @map("client_id")
  agentId    String?  @map("agent_id")
  priceId    String?  @map("price_id")

  // Route
  portOrigin       String @map("port_origin")
  portDestination  String @map("port_destination")
  containerType    String @map("container_type")

  // Cargo details
  cargoCategory    String @map("cargo_category")
  cargoWeight      String @map("cargo_weight")
  cargoReadyDate   DateTime @map("cargo_ready_date")

  // Pricing breakdown
  shippingLine           String  @map("shipping_line")
  freightPrice           Float @map("freight_price")
  portTaxes              Float @map("port_taxes")
  customsTaxes           Float @map("customs_taxes")
  terrestrialTransport   Float @map("terrestrial_transport")
  commission             Float @map("commission")
  totalPrice             Float @map("total_price")

  // Supplier info
  supplierName    String?  @map("supplier_name")
  supplierPhone   String?  @map("supplier_phone")
  supplierEmail   String?  @map("supplier_email")
  supplierAddress String?  @map("supplier_address")

  // Status tracking
  status          String @default("CONFIRMED") // CONFIRMED, SENT, IN_TRANSIT, ARRIVED, DELIVERED, CANCELLED
  departureDate   DateTime?     @map("departure_date")
  eta             DateTime?     @map("eta")
  actualArrival   DateTime?     @map("actual_arrival")

  // Notes
  internalNotes   String?  @map("internal_notes")
  clientNotes     String?  @map("client_notes")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  client       Client       @relation(fields: [clientId], references: [id])
  agent        Agent?       @relation(fields: [agentId], references: [id])
  selectedPrice AgentPrice? @relation(fields: [priceId], references: [id])

  containers   Container[]
  documents    Document[]
  invoices     Invoice[]
  notifications Notification[]

  @@index([clientId])
  @@index([agentId])
  @@index([status])
  @@map("bookings")
}

model Container {
  id               String   @id @default(uuid())
  bookingId        String   @map("booking_id")
  containerNumber  String   @unique @map("container_number")

  // Specs
  type             String
  sealNumber       String?  @map("seal_number")

  // Tracking
  currentStatus    String?  @map("current_status")
  currentLocation  String?  @map("current_location")
  currentLat       Float? @map("current_lat")
  currentLng       Float? @map("current_lng")

  // ETA
  eta              DateTime? @map("eta")
  actualArrival    DateTime? @map("actual_arrival")

  // API source
  apiSource        String?  @map("api_source")
  lastSyncAt       DateTime? @map("last_sync_at")

  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  booking        Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  trackingEvents TrackingEvent[]

  @@index([bookingId])
  @@index([containerNumber])
  @@map("containers")
}

model TrackingEvent {
  id          String   @id @default(uuid())
  containerId String   @map("container_id")

  // Event details
  eventType   String   @map("event_type")
  location    String
  portName    String?  @map("port_name")
  vessel      String?

  // Geo
  latitude    Float?
  longitude   Float?

  // Timing
  eventDate   DateTime @map("event_date")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  container Container @relation(fields: [containerId], references: [id], onDelete: Cascade)

  @@index([containerId])
  @@map("tracking_events")
}

// ============================================
// 5. DOCUMENTS & FILES
// ============================================

model Document {
  id         String   @id @default(uuid())
  bookingId  String?  @map("booking_id")

  // File info
  fileName   String   @map("file_name")
  fileType   String   @map("file_type")
  mimeType   String   @map("mime_type")
  fileSize   Int      @map("file_size")

  // Storage
  storageKey String   @unique @map("storage_key")
  url        String?

  // OCR/AI extracted data (stored as JSON string)
  extractedData String?  @map("extracted_data")

  uploadedBy String   @map("uploaded_by")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  // Relations
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([fileType])
  @@map("documents")
}

// ============================================
// 6. FINANCIAL
// ============================================

model Invoice {
  id            String   @id @default(uuid())
  invoiceNumber String   @unique @map("invoice_number")

  bookingId     String   @map("booking_id")
  clientId      String   @map("client_id")

  // Amounts
  amount        Float
  currency      String   @default("USD")

  // Dates
  issueDate     DateTime @default(now()) @map("issue_date")
  dueDate       DateTime @map("due_date")
  paidDate      DateTime? @map("paid_date")

  // Status
  status        String @default("UNPAID") // UNPAID, PAID, OVERDUE, CANCELLED

  // Files
  pdfUrl        String?  @map("pdf_url")

  // Notes
  notes         String?

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  booking  Booking  @relation(fields: [bookingId], references: [id])
  client   Client   @relation(fields: [clientId], references: [id])
  payments Payment[]

  @@index([clientId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model Payment {
  id          String   @id @default(uuid())
  invoiceId   String   @map("invoice_id")

  amount      Float
  currency    String   @default("USD")

  method      String // BANK_TRANSFER, CASH, CARD, OTHER
  reference   String?

  paidAt      DateTime @default(now()) @map("paid_at")
  notes       String?

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("payments")
}

// ============================================
// 7. NOTIFICATIONS & COMMUNICATIONS
// ============================================

model Notification {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  bookingId  String?  @map("booking_id")

  // Content
  type       String // BOOKING_CONFIRMED, BOOKING_STATUS_CHANGED, etc
  title      String
  message    String

  // Delivery (stored as comma-separated string)
  channels   String // "email,sms,whatsapp"

  // Status
  read       Boolean  @default(false)
  sent       Boolean  @default(false)
  sentAt     DateTime? @map("sent_at")

  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

model EmailQueue {
  id          String   @id @default(uuid())

  // Recipients (stored as comma-separated strings)
  to          String
  cc          String   @default("")
  bcc         String   @default("")

  // Content
  subject     String
  htmlBody    String   @map("html_body")
  textBody    String?  @map("text_body")

  // Attachments (stored as JSON string)
  attachments String?

  // Metadata
  template    String?
  bookingId   String?  @map("booking_id")

  // Status
  status      String @default("PENDING") // PENDING, SENDING, SENT, FAILED, CANCELLED
  attempts    Int      @default(0)
  lastError   String?  @map("last_error")

  scheduledFor DateTime? @map("scheduled_for")
  sentAt       DateTime? @map("sent_at")

  createdAt    DateTime @default(now()) @map("created_at")

  @@index([status])
  @@index([scheduledFor])
  @@map("email_queue")
}

// ============================================
// 8. SYSTEM & AUDIT
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")

  // Action details
  action      String
  entityType  String   @map("entity_type")
  entityId    String?  @map("entity_id")

  // Changes (stored as JSON string)
  changes     String?

  // Request info
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

model BackgroundJob {
  id          String   @id @default(uuid())

  // Job details
  jobType     String   @map("job_type")
  jobData     String   @map("job_data") // JSON string

  // Scheduling
  status      String @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED, CANCELLED
  attempts    Int      @default(0)
  maxAttempts Int      @default(3) @map("max_attempts")

  scheduledFor DateTime? @map("scheduled_for")
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")

  // Error handling
  lastError    String?  @map("last_error")

  createdAt    DateTime @default(now()) @map("created_at")

  @@index([status])
  @@index([jobType])
  @@index([scheduledFor])
  @@map("background_jobs")
}
